<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Jornada Divertida</title>

    <link rel="icon" href="icon.svg">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1d3557">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <h1>Mi Jornada</h1>
        <button id="dark-mode-toggle">☀️</button>
        <div id="user-info" class="hidden">
            <span id="user-email"></span>
            <button id="logout-button">Salir</button>
        </div>
    </header>

    <main>
        <section id="auth-view">
            <div class="auth-card" id="login-card">
                <h2>¡Bienvenido!</h2>
                <p class="slogan">Tu aliado para una jornada productiva y ordenada.</p>
                <form id="login-form">
                    <div class="form-group">
                        <input type="email" id="login-email" placeholder="Correo" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-password" placeholder="Contraseña" required autocomplete="current-password">
                    </div>
                    <button type="submit">Ingresar</button>
                </form>
                <p><a href="#" id="forgot-password-link">¿Olvidaste tu contraseña?</a></p>
            </div>
        </section>

        <section id="app-view" class="hidden">
            <div class="controls-container">
                <div class="date-filter-container">
                    <label for="date-filter">Ver tareas del día:</label>
                    <input type="date" id="date-filter">
                    <button id="today-button">Hoy</button>
                </div>
                <div class="report-container">
                    <button id="generate-morning-report-button">Reporte Mañana</button>
                    <button id="generate-afternoon-report-button">Reporte Tarde</button>
                    <button id="generate-weekly-report-button">Reporte Semanal</button>
                </div>
            </div>

            <div id="selected-date-display" class="selected-date">
                Mostrando tareas del: <span id="selected-date-text"></span>
            </div>

            <div class="tasks-container">
                <div class="tasks-section">
                    <h2>Tareas de la Mañana</h2>
                    <div class="task-list pending" id="morning-tasks-pending"></div>
                    <div class="task-list completed" id="morning-tasks-completed"></div>
                </div>
                <div class="tasks-section">
                    <h2>Tareas de la Tarde</h2>
                    <div class="task-list pending" id="afternoon-tasks-pending"></div>
                    <div class="task-list completed" id="afternoon-tasks-completed"></div>
                </div>
            </div>

            <div class="tasks-section" style="margin-top: 20px;">
                <h2>Penalidades del Día</h2>
                <div class="task-list" id="penalties-list"></div>
            </div>

            <button id="add-task-button" class="fab">+</button>
        </section>
    </main>

    <div id="add-task-modal" class="modal hidden">
        <div class="modal-content" id="add-task-modal-content">
            <h2>Nueva Tarea</h2>
            <form id="add-task-form">
                <div class="form-group">
                    <input type="text" id="task-title" placeholder="Título de la tarea" required>
                </div>
                <div class="form-group">
                    <textarea id="task-description" placeholder="Descripción..." required></textarea>
                </div>
                <div class="form-group">
                    <input type="datetime-local" id="task-deadline" required>
                </div>
                <label>
                    <input type="checkbox" id="task-mandatory">
                    ¿Es obligatoria?
                </label>
                <button type="submit">Guardar Tarea</button>
            </form>
        </div>
    </div>

    <div id="camera-modal" class="modal hidden">
        <div class="modal-content">
            <video id="camera-feed" autoplay playsinline></video>
            <button id="capture-button">Tomar Foto</button>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <button id="switch-camera-button" class="hidden">Cambiar Cámara</button>
            <button id="upload-button" class="hidden">Subir Evidencia</button>
        </div>
    </div>

    <div id="comment-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Añadir Comentario</h2>
            <form id="comment-form">
                <textarea id="comment-text" placeholder="Escribe tu comentario..." required></textarea>
                <button type="submit">Enviar Comentario</button>
            </form>
        </div>
    </div>

    <div id="report-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="report-modal-title">Reporte de Cumplimiento</h2>
            <div id="report-content"></div>
            <div id="report-actions" class="hidden">
                <hr>
                <button id="assign-reward-button">Asignar Recompensa</button>
            </div>
            <div id="penalty-actions" class="hidden">
                <hr>
                <h3>Sugerir una Penalidad</h3>
                <form id="penalty-form">
                    <div class="form-group">
                        <input type="text" id="penalty-title" placeholder="Título de la penalidad" required>
                    </div>
                    <div class="form-group">
                        <textarea id="penalty-description" placeholder="Descripción de la penalidad..." required></textarea>
                    </div>
                    <div class="form-group">
                        <input type="datetime-local" id="penalty-deadline" required>
                    </div>
                    <button type="submit">Sugerir Penalidad</button>
                </form>
            </div>
            <button id="close-report-button">Cerrar</button>
        </div>
    </div>

    <div id="weekly-report-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Reporte Semanal de Cumplimiento</h2>
            <div id="weekly-report-content"></div>
            <div id="weekly-report-actions" class="hidden">
            </div>
            <button id="close-weekly-report-button">Cerrar</button>
        </div>
    </div>

    <div id="reward-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Asignar Recompensa</h2>
            <form id="reward-form">
                <textarea id="reward-text" placeholder="Describe la recompensa..." required></textarea>
                <button type="submit">Guardar Recompensa</button>
            </form>
        </div>
    </div>

    <div id="negotiation-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="negotiation-modal-title">Proponer Alternativa</h2>
            <form id="negotiation-form">
                <div class="form-group">
                    <input type="text" id="negotiation-title" placeholder="Nuevo título de la penitencia" required>
                </div>
                <div class="form-group">
                    <textarea id="negotiation-description" placeholder="Nueva descripción..." required></textarea>
                </div>
                <button type="submit">Enviar Propuesta</button>
            </form>
        </div>
    </div>

    <div id="supervisor-rejection-options-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Rechazar Propuesta</h2>
            <p>La contrapropuesta del supervisado será rechazada. ¿Qué deseas hacer a continuación?</p>
            <div class="modal-actions">
                <button id="restore-original-penalty-btn">Restaurar Penalidad Original</button>
                <button id="propose-new-penalty-btn">Hacer una Contrapropuesta</button>
            </div>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Restablecer Contraseña</h2>
            <form id="forgot-password-form">
                <div class="form-group">
                    <input type="email" id="forgot-password-email" placeholder="Correo electrónico" required>
                </div>
                <button type="submit">Enviar enlace de restablecimiento</button>
            </form>
        </div>
    </div>
    
    <div id="ai-assistance-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Asistencia de IA para Penalidad</h2>
            <p>Se ha alcanzado el límite de negociaciones. Copia el siguiente texto y pégalo en tu IA de preferencia para obtener una penalidad justa y razonable.</p>
            <div class="prompt-wrapper">
                <pre id="ai-prompt-container"></pre>
                <button id="copy-prompt-button">Copiar Prompt</button>
            </div>
            <hr>
            <h3>Establecer Penalidad Final</h3>
            <form id="final-penalty-form">
                <div class="form-group">
                    <input type="text" id="final-penalty-title" placeholder="Título de la penalidad final" required>
                </div>
                <div class="form-group">
                    <textarea id="final-penalty-description" placeholder="Descripción de la penalidad final..." required></textarea>
                </div>
                <button type="submit">Guardar Penalidad Final</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
    <script type="module" src="js/main.js"></script>
    
    <script>
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            darkModeToggle.textContent = isDarkMode ? '🌙' : '☀️';
            localStorage.setItem('darkMode', isDarkMode);
        });
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = '🌙';
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // CORRECCIÓN FINAL: Apuntar a la ruta correcta '/public/sw.js'
                navigator.serviceWorker.register('/public/sw.js').then(registration => {
                    console.log('ServiceWorker registrado con éxito:', registration.scope);
                }).catch(error => {
                    console.log('Fallo en el registro de ServiceWorker:', error);
                });
            });
        }
    </script>
</body>
</html>